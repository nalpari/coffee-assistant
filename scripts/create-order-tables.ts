/**
 * Supabaseì— ì£¼ë¬¸ ì‹œìŠ¤í…œ í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 */
import { createClient } from '@supabase/supabase-js';
import * as fs from 'fs';
import * as path from 'path';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY!;

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  console.error('NEXT_PUBLIC_SUPABASE_URLê³¼ NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEYë¥¼ í™•ì¸í•˜ì„¸ìš”.');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function createOrderTables() {
  console.log('ğŸš€ ì£¼ë¬¸ ì‹œìŠ¤í…œ í…Œì´ë¸” ìƒì„± ì‹œì‘...\n');

  const migrationPath = path.join(
    process.cwd(),
    'supabase/migrations/20250002000000_create_order_system.sql'
  );

  // ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì½ê¸°
  const sql = fs.readFileSync(migrationPath, 'utf-8');

  try {
    // SQL ì‹¤í–‰
    const { error } = await supabase.rpc('exec_sql', { sql_query: sql });

    if (error) {
      console.error('âŒ í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨:', error);

      // ê°œë³„ í…Œì´ë¸” ìƒì„± ì‹œë„
      console.log('\nâš ï¸  ê°œë³„ SQL ì‹¤í–‰ ì‹œë„ ì¤‘...\n');
      await createTablesIndividually();
      return;
    }

    console.log('âœ… ì£¼ë¬¸ ì‹œìŠ¤í…œ í…Œì´ë¸” ìƒì„± ì™„ë£Œ!');
    console.log('\nìƒì„±ëœ í…Œì´ë¸”:');
    console.log('  - orders (ì£¼ë¬¸)');
    console.log('  - order_items (ì£¼ë¬¸ ìƒí’ˆ)');
    console.log('  - payments (ê²°ì œ)');
    console.log('\ní…Œì´ë¸” í™•ì¸: Supabase Dashboard â†’ Table Editor');
  } catch (err) {
    console.error('âŒ ì˜ˆì™¸ ë°œìƒ:', err);
    console.log('\nâš ï¸  ê°œë³„ SQL ì‹¤í–‰ ì‹œë„ ì¤‘...\n');
    await createTablesIndividually();
  }
}

async function createTablesIndividually() {
  const queries = [
    {
      name: 'orders í…Œì´ë¸”',
      sql: `
        CREATE TABLE IF NOT EXISTS public.orders (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          order_number VARCHAR(50) UNIQUE NOT NULL,
          customer_name VARCHAR(100) NOT NULL,
          customer_phone VARCHAR(20) NOT NULL,
          customer_email VARCHAR(255),
          total_amount INTEGER NOT NULL,
          discount_amount INTEGER DEFAULT 0 NOT NULL,
          final_amount INTEGER NOT NULL,
          status VARCHAR(50) NOT NULL DEFAULT 'pending',
          order_notes TEXT,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
          confirmed_at TIMESTAMP WITH TIME ZONE,
          completed_at TIMESTAMP WITH TIME ZONE
        );
      `,
    },
    {
      name: 'order_items í…Œì´ë¸”',
      sql: `
        CREATE TABLE IF NOT EXISTS public.order_items (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          order_id BIGINT NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
          menu_id BIGINT NOT NULL REFERENCES public.menu(id),
          menu_name VARCHAR(255) NOT NULL,
          menu_price INTEGER NOT NULL,
          quantity INTEGER NOT NULL DEFAULT 1 CHECK (quantity > 0),
          temperature VARCHAR(10),
          item_price INTEGER NOT NULL,
          item_total INTEGER NOT NULL,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
        );
      `,
    },
    {
      name: 'payments í…Œì´ë¸”',
      sql: `
        CREATE TABLE IF NOT EXISTS public.payments (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          order_id BIGINT NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
          payment_method VARCHAR(50) NOT NULL,
          amount INTEGER NOT NULL,
          status VARCHAR(50) NOT NULL DEFAULT 'success',
          mock_transaction_id VARCHAR(100) NOT NULL,
          mock_approval_number VARCHAR(100),
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
        );
      `,
    },
    {
      name: 'RLS ì •ì±…',
      sql: `
        ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
        ALTER TABLE public.order_items ENABLE ROW LEVEL SECURITY;
        ALTER TABLE public.payments ENABLE ROW LEVEL SECURITY;

        DROP POLICY IF EXISTS "orders_policy" ON public.orders;
        CREATE POLICY "orders_policy" ON public.orders FOR ALL TO public USING (true) WITH CHECK (true);

        DROP POLICY IF EXISTS "order_items_policy" ON public.order_items;
        CREATE POLICY "order_items_policy" ON public.order_items FOR ALL TO public USING (true) WITH CHECK (true);

        DROP POLICY IF EXISTS "payments_policy" ON public.payments;
        CREATE POLICY "payments_policy" ON public.payments FOR ALL TO public USING (true) WITH CHECK (true);
      `,
    },
  ];

  for (const query of queries) {
    try {
      const { error } = await supabase.rpc('exec_sql', { sql_query: query.sql });

      if (error) {
        console.error(`âŒ ${query.name} ìƒì„± ì‹¤íŒ¨:`, error.message);
      } else {
        console.log(`âœ… ${query.name} ìƒì„± ì™„ë£Œ`);
      }
    } catch (err) {
      console.error(`âŒ ${query.name} ì˜ˆì™¸:`, err);
    }
  }

  console.log('\nâš ï¸  ì¼ë¶€ í…Œì´ë¸” ìƒì„±ì´ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  console.log('Supabase Dashboard â†’ SQL Editorì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
}

createOrderTables();
